<!doctype html>
<html lang="en">
<head>
  <link rel="icon" href="favicon.png" type="image/png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miner • Hyper-Hash</title>
  <meta name="description" content="Miner details for Hyper-Hash pool."/>
  <style>
    :root{
      color-scheme:dark;
      --bg:#0b0d10;
      --panel:#0f1419;
      --ink:#e7edf3;
      --muted:#8ea0b2;
      --line:#14202c;
      --accent:#7cd1ff;
      --good:#41d17d;
      --warn:#f2c14e;
      --bad:#ff6b6b;
      --rad:18px;
      --pad:18px;
      --max:1100px;
      --gap:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:var(--max);margin:0 auto;padding:0 20px}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .topbar{display:flex;align-items:center;gap:12px;padding:16px 0 8px}
    .back{border:1px solid var(--line);border-radius:10px;padding:6px 10px;background:#111820;text-decoration:none}
    h1{margin:6px 0 0;font-size:clamp(22px,3.2vw,34px)}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--rad);padding:var(--pad);margin: var(--gap) 0}
    .card h2{margin:0 0 8px;font-size:14px;letter-spacing:.14em;text-transform:uppercase;color:var(--muted)}
    .grid{display:grid;gap:var(--gap);grid-template-columns:1fr}
    @media(min-width:860px){.grid{grid-template-columns:2fr 1fr}}
    .stats{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:600px){.stats{grid-template-columns:repeat(4,1fr)}}
    .kv{padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#0b1218;display:flex;justify-content:space-between}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:14px}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid #243545}
    .hint{font-size:12px;color:var(--muted)}
    .chart{height:220px;border:1px dashed #23303f;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#5b748c}
    footer{margin:24px 0 40px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="topbar">
      <a class="back" href="index.html">← Back</a>
      <div>
        <div class="muted">Miner</div>
        <h1 id="minerTitle" class="mono">—</h1>
      </div>
    </div>

    <section class="card">
      <div class="stats">
        <div class="kv"><span>Current hashrate</span><strong id="m-hash">—</strong></div>
        <div class="kv"><span>24h average</span><strong id="m-hash24">—</strong></div>
        <div class="kv"><span>Accepted</span><strong id="m-acc">—</strong></div>
        <div class="kv"><span>Rejected</span><strong id="m-rej">—</strong></div>
      </div>
      <div class="hint" style="margin-top:8px">Auto-refreshes every 30s.</div>
    </section>

    <section class="grid">
      <div class="card">
        <h2>Hashrate (last 24h)</h2>
        <div id="hashChart" class="chart">Graph placeholder</div>
      </div>
      <div class="card">
        <h2>Connection</h2>
        <div class="kv"><span>Address</span><span id="m-addr" class="mono">—</span></div>
        <div class="kv"><span>Workers</span><span id="m-workers">—</span></div>
        <div class="kv"><span>Last share</span><span id="m-lastshare">—</span></div>
        <div class="kv"><span>Difficulty</span><span id="m-diff">—</span></div>
      </div>
    </section>

    <section class="card">
      <h2>Workers</h2>
      <table class="tbl">
        <thead><tr><th>Worker</th><th>Hashrate</th><th>Accepted</th><th>Rejected</th><th>Last Share</th></tr></thead>
        <tbody id="workersBody"><tr><td class="muted" colspan="5">Loading…</td></tr></tbody>
      </table>
    </section>

    <section class="card">
      <h2>Recent Shares</h2>
      <table class="tbl">
        <thead><tr><th>Time</th><th>Worker</th><th>Difficulty</th><th>Status</th></tr></thead>
        <tbody id="sharesBody"><tr><td class="muted" colspan="4">Loading…</td></tr></tbody>
      </table>
    </section>
  </main>

  <footer>
  © 2025 Hyper-Hash •
  <a href="https://github.com/caldefenwycke" target="_blank" rel="noopener">GitHub</a> •
  <a href="https://discord.gg/ayHp3SFJ" target="_blank" rel="noopener">Discord</a>
</footer>

  <script>
    // --- tiny helpers ---
    function qp(name){ const u = new URL(window.location.href); return u.searchParams.get(name) || ''; }
    function fmtGH(ghs){
      if (ghs == null) return '—';
      if (ghs >= 1e6) return (ghs/1e6).toFixed(2) + ' PH/s';
      if (ghs >= 1e3) return (ghs/1e3).toFixed(2) + ' TH/s';
      return Number(ghs).toFixed(1) + ' GH/s';
    }
    function isoToLocal(s){
      if(!s) return '—';
      try { return s.replace('T',' ').replace('Z',''); } catch { return s; }
    }

    const minerId = qp('id') || qp('address') || '';
    document.getElementById('minerTitle').textContent = minerId || 'Unknown';

    async function load(){
      try{
        const res = await fetch('/api/miners.json', { cache: 'no-store' });
        const data = await res.json(); // { miners: [...] }
        const miners = Array.isArray(data.miners) ? data.miners : [];

        // pick matches: full id match, or address match when no slash
        let matches = [];
        if (minerId) {
          if (minerId.includes('/')) {
            matches = miners.filter(m => m.id === minerId);
          } else {
            matches = miners.filter(m => (m.address || '').toLowerCase() === minerId.toLowerCase());
          }
        } else {
          // no id given -> show everything
          matches = miners;
        }

        // Aggregate
        const totalHashGHS = matches.reduce((a,m)=>a+(m.hashrate_ghs||0),0);
        const totalAcc = matches.reduce((a,m)=>a+(m.accepted||0),0);
        const totalRej = matches.reduce((a,m)=>a+(m.rejected||0),0);
        const lastShare = matches
          .map(m=>m.last_share)
          .filter(Boolean)
          .sort()
          .slice(-1)[0] || null;

        // Fill header + connection
        const addressShown = minerId && !minerId.includes('/') ? minerId : (matches[0]?.address || minerId || '—');
        document.getElementById('m-hash').textContent = fmtGH(totalHashGHS);
        document.getElementById('m-hash24').textContent = fmtGH(totalHashGHS); // stub: same as current
        document.getElementById('m-acc').textContent = totalAcc.toLocaleString();
        document.getElementById('m-rej').textContent = totalRej.toLocaleString();
        document.getElementById('m-addr').textContent = addressShown;
        document.getElementById('m-workers').textContent = matches.length;
        document.getElementById('m-lastshare').textContent = isoToLocal(lastShare);
        document.getElementById('m-diff').textContent = '—';

        // Workers table
        const wb = document.getElementById('workersBody');
        wb.innerHTML = '';
        if (!matches.length) {
          wb.innerHTML = '<tr><td class="muted" colspan="5">No workers found for this miner.</td></tr>';
        } else {
          matches.forEach(w=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="mono">${w.worker || w.id || '—'}</td>
              <td>${fmtGH(w.hashrate_ghs)}</td>
              <td>${(w.accepted||0).toLocaleString()}</td>
              <td>${(w.rejected||0).toLocaleString()}</td>
              <td>${isoToLocal(w.last_share)}</td>
            `;
            wb.appendChild(tr);
          });
        }

        // Recent Shares (stubbed from worker last_share)
        const sb = document.getElementById('sharesBody');
        sb.innerHTML = '';
        if (!matches.length) {
          sb.innerHTML = '<tr><td class="muted" colspan="4">No share data.</td></tr>';
        } else {
          matches
            .slice(0, 10)
            .forEach(s=>{
              const pill = `<span class="pill" style="border-color:#234b35;background:#10251a;color:#86e0a9">accepted</span>`;
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${isoToLocal(s.last_share)}</td>
                <td class="mono">${s.worker || '—'}</td>
                <td>—</td>
                <td>${pill}</td>
              `;
              sb.appendChild(tr);
            });
        }
      }catch(e){
        console.error('miner load failed', e);
      }
    }

    load();
    setInterval(load, 30000);
  </script>
</body>
</html>

